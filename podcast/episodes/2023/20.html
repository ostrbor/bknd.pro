<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Backend Podcast: 20. Логгирование</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-normalize@2.0.0/modern-normalize.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="../../css/css.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div id="other-platforms">
        <a href="https://feeds.acast.com/public/shows/64727c07e689970012fb1c23">RSS</a>
        <a href="https://t.me/bkndpro">Telegram</a>
        <a href="https://www.youtube.com/@ostrbor/videos">YouTube</a>
        <a href="https://music.yandex.ru/album/28370806">Яндекс</a>
        <a href="https://open.spotify.com/show/6G9K0DrOH2wsEqDKbed01e?si=oQXKuI4tQKqgJj894-2p_A">Spotify</a>
        <a href="https://podcasts.google.com/feed/aHR0cHM6Ly9mZWVkcy5hY2FzdC5jb20vcHVibGljL3Nob3dzLzY0NzI3YzA3ZTY4OTk3MDAxMmZiMWMyMw">Google</a>
        <a href="https://music.amazon.com/podcasts/d797927c-7c90-4d4b-a845-3b61dc25060c/backend-podcast">Amazon</a>
        <a href="mailto:OstretsovAA+podcast@gmail.com">Почта</a>
    </div>
    <hgroup>
        <h1>20. Логгирование</h1>
        <h2>07.10.2023</h2>
    </hgroup>

    <p>
        <iframe src="https://embed.acast.com/64727c07e689970012fb1c23/6521bd0cb3400800116c9e76?theme=light" frameBorder="0"
                width="100%" height="190px"></iframe>
        <a href="https://bknd.pro/podcast-files/020_backend_podcast.mp3">Скачать</a>
    </p>

    <p>
        <a href="../../index.html">К списку выпусков</a>
    </p>

    <p>
        Логгирование зачастую может удовлетоврить потребности в том числе в мониторинге и трейсинге.
        Рассматривая эволюцию решений "от простого к сложному" очевидно, что проще использовать обогащенное логгирование
        и
        усложнять систему по мере надобности, выделяя трейсинг и мониторинг в отдельные решения.
    </p>


    <h4>1. Логгирование, мониторинг, трейсинг.</h4>

    <p>
        <strong>Логгирование</strong> - процесс записи событий в хронологическом порядке.<br/>
        <strong>Мониторинг</strong> - это процесс наблюдение за состоянием системы. Смотрим метрики, если система
        "захворала", то отправляем алерты.<br/>
        <strong>Трассировка</strong> - накопление данных, достаточных для последующего отслеживания пути запроса по
        распределенной системе.<br/>
    </p>

    <p>
        Все эти инструменты часто пересекаются в своем функционале. В наших системах с небольшой и умеренной нагрузкой
        мы используем логгирование в качестве решения в том числе задач трассировки и мониторинга.
    </p>

    <p>
        Объединение логгирования с трейсингом и мониторингом может покрыть лишь часть функционала, т.к. при избыточном
        логгировании доля ценной информации будет сокращаться. Так, для мониторинга часто лучше подходят time-series БД,
        а для логов и трейсов документные или реляционные.
    </p>


    <h4>2. Объединение логгирования и трейсинга.</h4>

    <p>
        Отличие логгирования и трейсинга - объем накапливаемой информации. Трейсинг часто хранит много легких данных
        о том как контроль выполнения переходит от одной системе к другой. Часто поэтому трейсинг используют, помимо
        отладки,
        для мониторинга производительности приложения: сколько запросов в секунду, как долго отрабатывали подсистемы в
        рамках запроса, частота ошибок, лейтенси и т.д.
    </p>

    <p>
        Чтобы к логгированию добавить трейсинг нужно, например:
    <ul>
        <li>назначать входящему запросу идентификатор: Trace-ID, Reference-ID или Span-ID.</li>
        <li>логгировать события с идентификатором с уровнем, например, TRACE или DEBUG передачу контроля управления
            подсистемам;
        </li>
        <li>предоставлять UI для навигации по запросам.</li>
    </ul>
    </p>


    <h4>3. Объединение логгирования и мониторинга.</h4>

    <p>
        Чтобы к логгированию добавить мониторинг, нужно:
    <ul>
        <li>логгировать о состоянии здоровья системы с уровнем ALERT (RFC 5424);</li>
        <li>алертить о появлении логов с этими уровнями.</li>
    </ul>
    </p>


    <h4>4. Где хранить логи?</h4>

    <p>
        Самое простое решение (и лучшее, если позволяет среда) - это файлы на диске. Удобный легкий поиск в командной
        строке,
        легкий менеджмент (ротация, архивирование и т.д.). С файлами работать достаточно просто.
    </p>

    <p>
        В распределенной среде нужно централизованное хранилище.
    </p>

    <p>
        При определенном объеме логгирования можно хорошо использовать реляционные БД, например,
        <strong>PostgreSQL</strong>.
        Эта БД вполне хорошо подходит, если писать до 3Гб в день, партицировать по месяцам/неделям и
        хранить логи не более 3х месяцев. Достаточно легко на PostgreSQL добиться 10 000+ записей в секунду.
        (использование COPY). Скорость сильно зависит от размеров буфера, автокомита, размера лог-записи, индексов,
        констрейнтов, дисков и т.д.
    </p>

    <p>
        <strong>ClickHouse</strong>. Запись от 50 000 до 200 000 записей в секунду (размер лог-записи до 1Кб). Есть
        эксприментальная
        фича с инвертированными индексами для полнотекстового поиска.
    </p>

    <p>
        У ClickHouse мне очень понравилась страница с бенчмарками: <a href="https://benchmark.clickhouse.com/">https://benchmark.clickhouse.com/</a>.
        Видно, что ClickHouse сильно выигрывает, если есть SUM, AVG, COUNT. Однако в запросах по первичному ключу, LIKE
        '%query%'
        PostgreSQL впереди (от 2 до 24 раз быстрее).
    </p>


    <h4>5. Ошибки в приложении и логи.</h4>

    <p>
        Ошибка в приложении содержит минимум данных, достаточных для различения одной ошибки от другой, но контекст,
        в которой возникла ошибка лучше описать в лог-записи.
    </p>


    <h4>6. Что логгировать?</h4>

    <p>
        Лог-записи должны быть короткими, максимально информативными. Когда случается пожар, некогда вчитывать в горы
        бесполезного текста.
    </p>

    <p>
        Логгирование часто воспринимается как что-то отвлекающее от решения задачи. Однако часто именно лог-сообщения
        помогают отличить качественное программное обеспечение от некачественного.
    </p>

    <p>
        Несколько рекомендаций:
    <ul>
        <li>четко поставить задачу перед системой логгирования;</li>
        <li>нет избыточности + логи должны отражать суть события;</li>
        <li>структурирование: подумайте о структурировании ваших логов, чтобы они легко анализировались;</li>
        <li>контекст: добавьте контекстные данные, которые помогут понять проблему или ситуацию.</li>
    </ul>
    </p>

    <p>
        <a href="../../index.html">К списку выпусков</a>
    </p>
</div>
</body>
</html>